REST API сервер для проверки цифровых подписей "Go GOST"
=======================================================

# Описание
REST API сервис для проверки открепленных цифровых подписей использующих алгоритмы хеширования ГОСТ Р 34.11-94, ГОСТ Р 34.11-2012 (256/512 бит)

# Минимальные требования
На компьютере должен быть установлен Go (Golang) версии не ниже 1.21.  
За дополнительной информацией обращайтесь на официальный сайт https://go.dev/

# Установка
Склонируйте репозиторий в нужную папку 
```
git clone https://github.com/vhar/go-stribog.git
```
Перейдите в папку go-stribog
```
cd go-stribog
```
Выполните последовательно команды
```
go mod init go-stribog
go mod tidy
```
Скопируйте содержимое файла config-example.yaml в файл config.yaml
```
cp config-example.yaml в файл config.yaml
```
Отредактируйте файл config.yaml в соответсвии с вашими потребностями

# Настройка
Настройка сервиса осуществляется установкой необходимых значений переменных в файле конфигурации

## Общие настройки

**env: local** - текущее окружение. Влияет на формат и уровень логирования.  
>Возможные варианты:  
>local - текстовый формат с уровнем debug  
>dev - json формат уровня bebug  
>prod - json формат уровня info  

**log_file: /var/log/apiserver.log** - полный путь к лог-файлу приложения
>Если имя файла не указано, логирование осуществляется в стандартный поток STDOUT (syslog)

## Секция server
**bind_addr: 127.0.0.1:8080** - адрес и порт, на котором будет запущен сервер  
**timeout: 5s** - максимальная продолжительность чтения запроса, включая тело.  
>Нулевое или отрицательное значение означает отсутствие таймаута

**idle_timeout: 30s** - максимальное ожидание следующего запороса для поддержания активного соединения. 
>Если равно нулю, но используется значение из timeout. 

**ssl_enabled: true** - использовать SSL
>true - запустить сервер с использованием протокола HTTPS
>false - запустить сервер с использованием протокола HTTP
>Если значение ssl_enabled = true, необходимо указать полный путь до файлов сертификатов

**ssl_chain: /etc/ssl/example.com/fullchain.pem** - Пусть к файлу с цепочкой сертификатов
>Необходимо указать путь к файлу с полной цепочкой сертификатов, начиная от сертификата сайта, заканчивая сертификатом удостоверяющего центра

**ssl_key: /etc/ssl/example.com/privkey.pem** - путь к файлу закрытого ключа

## Секция client
>Настроки HTTP клиента для проверки файлов на удаленных серверах

**timeout: 30s** - максимальное время ожидания ответа от удаленного сервера.  
**user_agent: Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko** - значение заголовка User-Agent для HTTP клиента  

# Запуск сервиса
Сервис можно запустить несколькими способами:
1. Из исходных файлов.  
В папке с исходным кодом выполните:  
```
go run ./cmd/main.go &
```
2. Превариельно скомпилированного файла.  
Скомпилировать файл нужно один раз. Для этого в папке go-stribog выполните
```
go build -o go-stribog ./cmd/main.go
```
В результате выполения данной команды в папке появиться испольняемый файл go-stribog  
Запустите скомпилированный файл:
```
./go-stribog &
```
>Файл config.yaml должен находиться в той же папке, что и скомпилированный файл 
3. Как системный сервис в Linux.  
Для использования этого способа нужно предварительно скоипилировать испольняемый файл.  
Выполните в папке go-stribog:  
```
go build -o go-stribog ./cmd/main.go
```
Создайте папку ***/opt/go-stribog*** и скопируйте в нее созданный исполняемый файл и файл ***config.yaml***
```
sudo mkdir /opt/go-stribog && sudo cp ./go-stribog /opt/go-stribog && sudo cp ./config.yaml /opt/go-stribog
```
Скопируйте файл ***go-stribog.service.examle*** в папку ***/lib/systemd/system*** с именем ***go-stribog.service***
```
sudo cp go-stribog.service.examle /lib/systemd/system/go-stribog.service
```
Теперь можно запускать и останавливать сервис как и любые другие системные сервисы.  
Для запуска выполнить:
```
sudo systemctl start go-stribog
``` 
Для остановки выполнить:
```
sudo systemctl stop go-stribog
``` 
Посмотреть состояние:
```
sudo systemctl status go-stribog
``` 
Также, можно поставить сервис в автозагрузку
```
sudo systemctl enable go-stribog
``` 
Убрать сервис из автозагрузки:
```
sudo systemctl disable go-stribog
``` 

# Использование сервиса
В сервисе реализовано два метода проверки:  
1. **Verify File** - проверка с загрузкой файлов на сервер
2. **Verify URL** - проверка файлов расположенных на удаленном сервере  

Оба метода возвращают одинаковую JSON структуру отчета ***payload*** в случае успеха или структуру ошибки ***error*** содержащую поля ***message*** с описанием ошибки и ***code*** c HTTP кодом ошибки.  

Пример отчета:
```
{
    "payload":{
        "Signer": {
            "CommonName": "АО \"РОГА И КОПЫТА\"",
            "CountryName": "RU",
            "StateOrProvinceName": "64 Саратовская область",
            "LocalityName": "Арбатов",
            "Surname": "Паниковский",
            "GivenName": "Михаил Самуэльевич",
            "Title": "Уполномоченный по рогам",
            "EmailAddress": "misha@panikovsky.gov"
        },
        "Certificate": {
            "IssuerName": "УЦ Федерального казначейства",
            "NotBefore": "03.02.2015 08:26",
            "NotAfter": "03.05.2016 08:26",
            "EncriptionAlgorithm": "ГОСТ Р 34.11/34.10-2001",
            "DigestAlgorithm": "ГОСТ Р 34.11-94"
        },
        "SigningTime": "09.22.2016 09:50:00 UTC",
        "Validity": false
    }
}
```
> Поле Validity возвращает true в случае если файл подписи был создан для переданного документа и последний после этого не модифицировался.

Пример ошибки
```
{
    "error":{
        "code": 422,
        "message": "Ошибка загрузки файла документа."
    }
}
```

## Использование метода Verify File
Для проверки подписи необходимо отправить запрос методом **POST** на URN **/vfile**  
Content-Type: multipart/form-data  
В теле запроса необходимо передать проверяемый документ в поле ***document*** и файл подписи в поле ***signature***
```
<form method="post" action="/vfile" enctype="multipart/form-data">
  <input type="file" name="document" />
  <input type="file" name="signature" />
</form>
```

## Использование метода Verify URL
Для проверки подписи необходимо отправить запрос методом **POST** на URN **/vurl**  
Content-Type: application/json  
В теле запроса в поле ***document*** указать URL на проверяемый документ и в поле ***signature*** URL на файл с проверяемой подписью.  
Дополнительно в теле запроса можно передать поле ***referer*** если сервер, на котором расположены проверяемые файлы не позволяет обращаться у ним напрямую.  
```
{
  "document": "https://example.com/1b96db2c7e458802a4dd404d71f1c14d_166.pdf",
  "signature": "https://example.com/1b96db2c7e458802a4dd404d71f1c14d_166.pdf.sig",
  "referer": "https://mydomain.org"
}

```
